name: Combine Releases Properties

on:
    schedule:
        - cron: '0 */6 * * *'  # Runs every 6 hours
    workflow_dispatch:  # Allows manual triggering

jobs:
    combine-releases:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout this repository
              uses: actions/checkout@v4

            - name: Checkout other repositories
              run: |
                  repos=(
                    "module-adminer"
                    "module-apache"
                    "module-composer"
                    "module-consolez"
                    "module-filezilla"
                    "module-ghostscript"
                    "module-git"
                    "module-gitlist"
                    "module-mailhog"
                    "module-mariadb"
                    "module-memcached"
                    "module-mysql"
                    "module-ngrok"
                    "module-nodejs"
                    "module-perl"
                    "module-php"
                    "module-phpmemadmin"
                    "module-phpmyadmin"
                    "module-phppgadmin"
                    "module-postgresql"
                    "module-python"
                    "module-ruby"
                    "module-webgrind"
                    "module-xdc"
                    "module-xlight"
                    "module-yarn"
                  )
                  for repo in "${repos[@]}"; do
                    git clone "https://github.com/Bearsampp/$repo.git"
                  done

            - name: Retrieve releases.properties and combine into a single properties file
              run: |
                  combined_file="core/resources/quickpick.releases"
                  touch $combined_file

                  for repo in "${repos[@]}"; do
                    repo_url="https://github.com/Bearsampp/$repo"
                    if [ -f "$repo/releases.properties" ]; then
                      while IFS='=' read -r key value; do
                        if [ "$key" == "version" ]; then
                          version=$value
                          echo "$repo.version=$value" >> $combined_file
                          echo "$repo.url=$repo_url/releases/tag/$version" >> $combined_file
                        fi
                      done < "$repo/releases.properties"
                    fi
                  done

            - name: Commit and push changes
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  git config --global user.name "github-actions[bot]"
                  git config --global user.email "github-actions[bot]@users.noreply.github.com"
                  git checkout -b update-quickpick-releases
                  git add core/resources/quickpick.releases
                  git commit -m "Update quickpick.releases"
                  git pull --rebase origin main
                  git push origin update-quickpick-releases

            - name: Upload combined properties file as artifact
              uses: actions/upload-artifact@v2
              with:
                  name: combined-releases
                  path: core/resources/quickpick.releases
