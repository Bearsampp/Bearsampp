name: Combine Releases Properties

on:
    schedule:
        - cron: '0 */6 * * *'  # Runs every 6 hours
    workflow_dispatch:  # Allows manual triggering

jobs:
    combine-releases:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout this repository
              uses: actions/checkout@v4

            - name: Checkout other repositories
              run: |
                  repos=(
                    "module-adminer/releases.properties"
                    "module-apache/releases.properties"
                    "module-composer/releases.properties"
                    "module-consolez/releases.properties"
                    "module-filezilla/releases.properties"
                    "module-ghostscript/releases.properties"
                    "module-git/releases.properties"
                    "module-gitlist/releases.properties"
                    "module-mailhog/releases.properties"
                    "module-mariadb/releases.properties"
                    "module-memcached/releases.properties"
                    "module-mysql/releases.properties"
                    "module-ngrok/releases.properties"
                    "module-nodejs/releases.properties"
                    "module-perl/releases.properties"
                    "module-php/releases.properties"
                    "module-phpmemadmin/releases.properties"
                    "module-phpmyadmin/releases.properties"
                    "module-phppgadmin/releases.properties"
                    "module-postgresql/releases.properties"
                    "module-python/releases.properties"
                    "module-ruby/releases.properties"
                    "module-webgrind/releases.properties"
                    "module-xdc/releases.properties"
                    "module-xlight/releases.properties"
                    "module-yarn/releases.properties"
                  )
                  for repo in "${repos[@]}"; do
                    repo_name=$(echo $repo | cut -d'/' -f1)
                    echo "Cloning repository: $repo_name"
                    git clone "https://github.com/Bearsampp/$repo_name.git" || { echo "Failed to clone repository: $repo_name"; exit 1; }
                  done

            - name: Retrieve releases.properties and combine into a single properties file
              run: |
                  combined_file="core/resources/quickpick.releases"
                  touch $combined_file

                  for repo in "${repos[@]}"; do
                    repo_name=$(echo $repo | cut -d'/' -f1)
                    repo_url="https://github.com/Bearsampp/$repo_name"
                    if [ -f "$repo_name/releases.properties" ]; then
                      while IFS='=' read -r key value; do
                        if [ "$key" == "version" ]; then
                          version=$value
                          echo "$repo_name.version=$value" >> $combined_file
                          echo "$repo_name.url=$repo_url/releases/tag/$version" >> $combined_file
                        fi
                      done < "$repo_name/releases.properties"
                    else
                      echo "No releases.properties file found for repository: $repo_name"
                    fi
                  done

            - name: Commit and push changes
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  git config --global user.name "github-actions[bot]"
                  git config --global user.email "github-actions[bot]@users.noreply.github.com"
                  git add core/resources/quickpick.releases
                  git commit -m "Update quickpick.releases"
                  git push origin main

            - name: Upload combined properties file as artifact
              uses: actions/upload-artifact@v2
              with:
                  name: combined-releases
                  path: core/resources/quickpick.releases
